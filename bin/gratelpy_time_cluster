import os
import cStringIO as StringIO
import socket
import sys

mechanism = os.path.join('gratelpy', 'mechanisms',
                         'reversible_substrate_inhibition.txt')
no_species = 4
queue = 'normal'
no_clients = 1

server = socket.gethostname()
name = os.path.split(mechanism)[-1].split('.')[0]

bash = StringIO.StringIO()
bash.write('#!/usr/bin/env bash\n')
bash.write('gratelpy_fragment_server '+mechanism+' '+str(no_species)+' &\n')

for c in range(no_clients):
    bash.write('bsub "gratelpy_subclient '+mechanism+' '+str(no_species)+''
               ' '+server+'" '+'-J '+name+' -o '+name+'.out.%J'+''
               ' '+'-q '+queue+'\n')

print(bash.getvalue())

if any([os.path.exists(name+ext) for ext in ['.dict', '.vsg']]):
    print('.dict or .vsg file detected for this mechanism: %s\n'
          'You need to delete both of these files, otherwise\n'
          'the fragment server will not start and clients will crash.' \
              % name)
    sys.exit(1)
else:
    os.system(bash.getvalue())
